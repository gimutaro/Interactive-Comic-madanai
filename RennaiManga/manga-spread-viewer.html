<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Éû„É≥„Ç¨Ë¶ãÈñã„Åç„Éö„Éº„Ç∏ V20ÔºàË°®Á¥ô„Çπ„Çø„Éº„ÉàÔºÜQR„ÉÜ„Ç≠„Çπ„ÉàÂâäÈô§Ôºâ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background: linear-gradient(135deg, #f0e6d2 0%, #e6d7c3 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow-x: hidden; }

    /* Êú¨‰Ωì */
    .book-container { position: relative; width: 1040px; height: 690px; perspective: 1500px; }
    .spread { position: absolute; width: 100%; height: 100%; display: flex; opacity: 0; visibility: hidden; transition: opacity .5s, visibility .5s; }
    .spread.active { opacity: 1; visibility: visible; }
    .page { width: 520px; height: 690px; position: relative; background: #fffcf9; overflow: hidden; }
    .page.left  { box-shadow: inset -10px 0 20px rgba(0,0,0,.1), -2px 0 5px rgba(0,0,0,.05); border-right: 1px solid rgba(0,0,0,.05); }
    .page.right { box-shadow: inset 10px 0 20px rgba(0,0,0,.1),  2px 0 5px rgba(0,0,0,.05); border-left:  1px solid rgba(0,0,0,.05); }
    .spread::after { content: ''; position: absolute; left: 50%; top: 0; width: 20px; height: 100%; transform: translateX(-50%); background: linear-gradient(to right, transparent, rgba(0,0,0,.2) 30%, rgba(0,0,0,.3) 50%, rgba(0,0,0,.2) 70%, transparent); pointer-events: none; z-index: 10; }
    .page.empty { background: transparent; box-shadow: none; border: none; }

    /* ÂÖ±ÈÄö */
    .manga-page { width: 100%; height: 100%; border: 3px solid #000; background: #fff; padding: 20px; position: relative; }
    .page-number { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 14px; color: #666; font-weight: 500; background: #fff; padding: 2px 8px; border-radius: 10px; }
    .koma { position: relative; border: 3px solid #000; overflow: hidden; background: #fafafa; }
    .koma img.koma-img-el { position:absolute; inset:0; width:100%; height:100%; object-fit: cover; display:block; }
    
    /* Ë°®Á¥ô„ÅÆ„Çπ„Çø„Ç§„É´ */
    .cover-container { 
      position: relative; 
      width: 110%;  /* Ê®™ÂπÖ„ÇíÂ∫É„Åè„Åô„Çã */
      height: 100%; 
      margin: 0 auto;  /* ‰∏≠Â§Æ„Å´ÈÖçÁΩÆ */
      border: 3px solid #000; 
      background: #fff; 
      overflow: hidden; 
    }
    .cover-image { 
      position: absolute; 
      top: -10px;
      left: -25px;  /* Â∑¶„Å´ÁßªÂãï */
      right: 5px;
      bottom: -10px;
      width: calc(100% + 20px); 
      height: calc(100% + 20px); 
      object-fit: contain;
      display: block; 
    }
    .cover-placeholder { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      font-size: 24px; 
      color: #999; 
      pointer-events: none; 
    }
    .cover-container.has-image .cover-placeholder { 
      display: none; 
    }

    /* ===== „Éö„Éº„Ç∏1Ôºà‰∏ä1 + ‰∏ã2Ôºâ ===== */
    .koma-1 { width: 100%; height: 350px; border: 3px solid #000; background: #fff; margin-bottom: 15px; position: relative; overflow: hidden; }
    .koma-container-bottom { width: 100%; height: 250px; display: flex; gap: 15px; }
    .koma-2, .koma-3 { flex: 1; height: 100%; border: 3px solid #000; background: #fff; position: relative; overflow: hidden; }

    /* ===== „Éö„Éº„Ç∏2ÔºàÊÆµ„Åî„Å®ÊØîÁéáÔºâ ===== */
    .layout-p2 { height: 100%; display: flex; flex-direction: column; gap: 12px; }
    .layout-p2 .row { display: flex; gap: 12px; flex: 1 0 0; }
    .layout-p2 .row.top   .left  { flex: 3; }
    .layout-p2 .row.top   .right { flex: 2; }
    .layout-p2 .row.mid   .left  { flex: 2; }
    .layout-p2 .row.mid   .right { flex: 3; }
    .layout-p2 .row.bottom .left  { flex: 3; }
    .layout-p2 .row.bottom .right { flex: 2; }

    /* ===== „Éö„Éº„Ç∏3Ôºà‰∏ä‰∏ã„Å†„ÅëÂ∑¶Âè≥ÊØîÁéá„ÇíÂèçËª¢Ôºö1&2 / 5&6Ôºâ ===== */
    .layout-p3 { height: 100%; display: flex; flex-direction: column; gap: 12px; }
    .layout-p3 .row { display: flex; gap: 12px; flex: 1 0 0; }
    .layout-p3 .row.top   .left  { flex: 3.5 1 0; }
    .layout-p3 .row.top   .right { flex: 1.5 1 0; }
    .layout-p3 .row.mid   .left  { flex: 1.5 1 0; }
    .layout-p3 .row.mid   .right { flex: 3.5 1 0; }
    .layout-p3 .row.bottom .left  { flex: 3.5 1 0; }
    .layout-p3 .row.bottom .right { flex: 1.5 1 0; }

    /* ===== „Éö„Éº„Ç∏4Ôºà‰∏äÊÆµ 1:1√ó2„ÄÅ‰∏ãÊÆµ ÂÖ®Èù¢Ôºâ ===== */
    .layout-p4 { height: 100%; display: flex; flex-direction: column; gap: 12px; }
    .layout-p4 .row { display: flex; gap: 12px; }
    .layout-p4 .row.top { flex: 0 0 auto; }
    .layout-p4 .row.top .koma { flex: 1 1 0; aspect-ratio: 1 / 1; }
    .layout-p4 .row.bottom { flex: 1 1 0; min-height: 0; }
    .layout-p4 .row.bottom .koma { flex: 1 1 0; height: 100%; }

    /* 4„Éö„Éº„Ç∏ÁõÆ 3„Ç≥„ÉûÁõÆ„ÅØ„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ */
    [data-page="4"] .koma[data-koma="3"] { cursor: zoom-in; }

    /* „Éä„ÉìÔºàinline onclick„ÇíÂªÉÊ≠¢ ‚Üí JS„Åß‰ªò‰∏éÔºâ */
    .nav-area { position: absolute; top:0; height:100%; width:50px; cursor:pointer; z-index:20; transition: background-color .3s; }
    .nav-area:hover { background-color: rgba(0,0,0,.05); }
    .nav-area.prev { right:0; }
    .nav-area.next { left:0; }
    .nav-area::after { content:''; position:absolute; top:50%; transform:translateY(-50%); width:0; height:0; border-style: solid; opacity:0; transition: opacity .3s; }
    .nav-area:hover::after { opacity:.5; }
    .nav-area.prev::after { right:15px; border-width:15px 0 15px 20px; border-color: transparent transparent transparent #333; }
    .nav-area.next::after { left:15px; border-width:15px 20px 15px 0; border-color: transparent #333 transparent transparent; }

    /* ===== „Ç∫„Éº„É†ÔºÜAI„Éú„ÉÉ„Éà ===== */
    #bookRoot { transform-origin: var(--zoom-origin-x) var(--zoom-origin-y); }
    #bookRoot.zooming-in { animation: cameraZoomIn .7s ease-out forwards; }
    #bookRoot.zooming-out { animation: cameraZoomOut .7s ease-out forwards; }

    @keyframes cameraZoomIn { 0% { transform: scale(1); filter: blur(0px); } 100% { transform: scale(25); filter: blur(8px); } }
    @keyframes cameraZoomOut { 0% { transform: scale(25); filter: blur(8px); } 100% { transform: scale(1); filter: blur(0px); } }

    .zoom-overlay { position: fixed; inset: 0; background: #000; opacity: 0; pointer-events: none; z-index: 30; transition: opacity .6s ease-out; }
    .zoom-overlay.active { opacity: 1; pointer-events: auto; }

    .ai-bot-wrapper { position: fixed; inset: 0; z-index: 40; display: none; opacity: 0; transition: opacity .5s ease; }
    .ai-bot-wrapper.active { display: block; opacity: 1; }

    .ai-bot-container { width: 100%; height: 100%; position: relative; background: #1a1a2e; }
    .image-background { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); grid-auto-rows: 120px; gap: 2px; padding: 2px; opacity: .3; overflow: hidden; }
    .bg-image-cell { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; position: relative; overflow: hidden; }
    .bg-image-cell::before { content: 'ü§ñ'; position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; font-size: 40px; opacity: .6; }
    .bg-image-cell:nth-child(2n)::before { content: 'üí¨'; }
    .bg-image-cell:nth-child(3n)::before { content: 'üé®'; }
    .bg-image-cell:nth-child(4n)::before { content: '‚ú®'; }
    .bg-image-cell:nth-child(5n)::before { content: 'üöÄ'; }
    .bg-image-cell:nth-child(6n)::before { content: 'üí°'; }
    .bg-image-cell:nth-child(7n)::before { content: 'üåü'; }

    .ai-response-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; max-height: 60vh; background: rgba(20,20,30,.9); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,.3); display: none; overflow-y: auto; }
    .ai-response-area.show { display: block; }
    .ai-response-text { font-size: 18px; line-height: 1.6; color: #fff; word-wrap: break-word; }

    .input-area { position: absolute; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(26,26,46, .98), rgba(26,26,46, .9)); padding: 20px; border-top: 2px solid rgba(255,255,255,.1); }
    .input-container { max-width: 800px; margin: 0 auto; display: flex; gap: 10px; }
    .text-input { flex: 1; padding: 15px 20px; font-size: 16px; border: 2px solid rgba(255,255,255,.2); border-radius: 30px; background: rgba(255,255,255,.1); color: #fff; outline: none; transition: all .3s; }
    .text-input::placeholder { color: rgba(255,255,255,.5); }
    .text-input:focus { border-color: #667eea; background: rgba(255,255,255,.15); }
    .submit-btn { padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 30px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all .3s; white-space: nowrap; }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,.4); }
    .submit-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    .back-btn { position: fixed; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; opacity: 0; z-index: 45; transition: opacity .3s; pointer-events: none; background: rgba(0,0,0,.3); width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
    .back-btn.visible { opacity: .85; pointer-events: auto; }
    .back-btn:hover { transform: scale(1.08); background: rgba(0,0,0,.5); }
  </style>
</head>
<body>
  <div class="book-container" id="bookRoot">
    <!-- Ë¶ãÈñã„Åç1ÔºàË°®Á¥ôÔºâ -->
    <div class="spread has-empty active" data-spread="1">
      <div class="page left">
        <div class="cover-container" id="front-cover" data-asset="cover_front">
          <img class="cover-image koma-img-el" alt="cover_front" data-name="cover_front" src=""
               onload="this.style.display='block'; this.parentElement.classList.add('has-image');"
               onerror="this.style.display='none';" />
          <div class="cover-placeholder">Ë°®Á¥ô</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right empty"></div>
    </div>

    <!-- Ë¶ãÈñã„Åç2Ôºö„Éö„Éº„Ç∏1 + Ë°®Á¥ôË£èÔºà‚Äª„ÉÜ„Ç≠„Çπ„ÉàÂâäÈô§Ôºâ -->
    <div class="spread" data-spread="2">
      <div class="page left">
        <div class="manga-page" data-page="1">
          <div class="koma-1 koma" data-koma="1" data-asset="p1_koma1">
            <img class="koma-img-el" alt="p1_koma1" data-name="p1_koma1" src="" />
          </div>
          <div class="koma-container-bottom">
            <div class="koma-2 koma" data-koma="2" data-asset="p1_koma2">
              <img class="koma-img-el" alt="p1_koma2" data-name="p1_koma2" src="" />
            </div>
            <div class="koma-3 koma" data-koma="3" data-asset="p1_koma3">
              <img class="koma-img-el" alt="p1_koma3" data-name="p1_koma3" src="" />
            </div>
          </div>
          <div class="page-number">1</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <!-- „Åì„Åì„ÅØË°®Á¥ôË£è„ÅÆ„Éó„É¨„Éº„É≥„Å™QRÊû†„ÅÆ„Åø„ÄÇÊñáË®Ä„ÇíÂâäÈô§ -->
        <div class="front-inside">
          <div class="qr-code-area" aria-label="QR"></div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- Ë¶ãÈñã„Åç3Ôºö„Éö„Éº„Ç∏3ÔºàÂ∑¶Ôºâ + „Éö„Éº„Ç∏2ÔºàÂè≥Ôºâ -->
    <div class="spread" data-spread="3">
      <div class="page left">
        <div class="manga-page layout-p3" data-page="3">
          <div class="row top">
            <div class="koma left"  data-koma="1" data-asset="p3_koma1">
                <img class="koma-img-el" alt="p3_koma1" data-name="p3_koma1" src="" />
            </div>
            <div class="koma right" data-koma="2" data-asset="p3_koma2">
              <img class="koma-img-el" alt="p3_koma2" data-name="p3_koma2" src="" />
            </div>
          </div>
          <div class="row mid">
            <div class="koma left"  data-koma="4" data-asset="p3_koma4">
              <img class="koma-img-el" alt="p3_koma4" data-name="p3_koma4" src="" />
            </div>
            <div class="koma right" data-koma="3" data-asset="p3_koma3">
              <img class="koma-img-el" alt="p3_koma3" data-name="p3_koma3" src="" />
            </div>
          </div>
          <div class="row bottom">
            <div class="koma left"  data-koma="5" data-asset="p3_koma5">
              <img class="koma-img-el" alt="p3_koma5" data-name="p3_koma5" src="" />
            </div>
            <div class="koma right" data-koma="6" data-asset="p3_koma6">
              <img class="koma-img-el" alt="p3_koma6" data-name="p3_koma6" src="" />
            </div>
          </div>
          <div class="page-number">3</div>
        </div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="manga-page layout-p2" data-page="2">
          <div class="row top">
            <div class="koma left"  data-koma="1" data-asset="p2_koma1">
                <img class="koma-img-el" alt="p2_koma1" data-name="p2_koma1" src="" />
            </div>
            <div class="koma right" data-koma="2" data-asset="p2_koma2">
              <img class="koma-img-el" alt="p2_koma2" data-name="p2_koma2" src="" />
            </div>
          </div>
          <div class="row mid">
            <div class="koma left"  data-koma="4" data-asset="p2_koma4">
              <img class="koma-img-el" alt="p2_koma4" data-name="p2_koma4" src="" />
            </div>
            <div class="koma right" data-koma="3" data-asset="p2_koma3">
              <img class="koma-img-el" alt="p2_koma3" data-name="p2_koma3" src="" />
            </div>
          </div>
          <div class="row bottom">
            <div class="koma left"  data-koma="5" data-asset="p2_koma5">
              <img class="koma-img-el" alt="p2_koma5" data-name="p2_koma5" src="" />
            </div>
            <div class="koma right" data-koma="6" data-asset="p2_koma6">
              <img class="koma-img-el" alt="p2_koma6" data-name="p2_koma6" src="" />
            </div>
          </div>
          <div class="page-number">2</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- Ë¶ãÈñã„Åç4Ôºö„Éö„Éº„Ç∏5ÔºàÂ∑¶Ôºâ + „Éö„Éº„Ç∏4ÔºàÂè≥Ôºâ -->
    <div class="spread" data-spread="4">
      <div class="page left">
        <div class="manga-page"><div class="page-number">5</div></div>
        <div class="nav-area next"></div>
      </div>
      <div class="page right">
        <div class="manga-page layout-p4" data-page="4">
          <div class="row top">
            <div class="koma" data-koma="1" data-asset="p4_koma1">
                <img class="koma-img-el" alt="p4_koma1" data-name="p4_koma1" src="" />
            </div>
            <div class="koma" data-koma="2" data-asset="p4_koma2">
              <img class="koma-img-el" alt="p4_koma2" data-name="p4_koma2" src="" />
            </div>
          </div>
          <div class="row bottom">
            <div class="koma" data-koma="3" data-asset="p4_koma3" id="p4k3">
              <img class="koma-img-el" alt="p4_koma3" data-name="p4_koma3" src="" />
            </div>
          </div>
          <div class="page-number">4</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>

    <!-- Ë¶ãÈñã„Åç5ÔºöË£èË°®Á¥ô -->
    <div class="spread has-empty" data-spread="5">
      <div class="page left empty"></div>
      <div class="page right">
        <div class="cover-container" id="back-cover" data-asset="cover_back">
          <img class="cover-image koma-img-el" alt="cover_back" data-name="cover_back" src=""
               onload="this.style.display='block'; this.parentElement.classList.add('has-image');"
               onerror="this.style.display='none';" />
          <div class="cover-placeholder">Ë£èË°®Á¥ô</div>
        </div>
        <div class="nav-area prev"></div>
      </div>
    </div>
  </div>

  <!-- „Ç∫„Éº„É†Áî®„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºÜAI„Éú„ÉÉ„Éà -->
  <div class="zoom-overlay" id="zoomOverlay"></div>
  <div class="ai-bot-wrapper" id="aiBotWrapper">
    <div class="ai-bot-container">
      <div class="image-background" id="imageBackground"></div>
      <div class="ai-response-area" id="aiResponseArea">
        <div class="ai-response-text" id="aiResponseText"></div>
      </div>
      <div class="input-area">
        <div class="input-container">
          <input type="text" class="text-input" id="userInput" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶" autocomplete="off" />
          <button class="submit-btn" id="submitBtn" type="button">ÂõûÁ≠î</button>
        </div>
      </div>
    </div>
  </div>
  <span class="back-btn" id="backBtn">&times;</span>

  <!-- „Åì„Åì„Åã„Çâ‰∏ã„ÅØÂøÖ„Åö <script> ÂÜÖ„ÄÇ„Çø„Ç§„Éó„ÅØ module „ÅßÂé≥Ê†º„Å´Ë™≠„ÅøËæº„Åø -->
  <script type="module">
    'use strict';

    // ============================
    //  „Éö„Éº„Ç∏Êìç‰Ωú
    // ============================
    let currentSpread = 1; const totalSpreads = 5; let isZoomed = false;
    function showSpread(n){ if(isZoomed) return; document.querySelectorAll('.spread').forEach(s=>s.classList.remove('active')); const t=document.querySelector(`[data-spread="${n}"]`); if(t) t.classList.add('active'); currentSpread=n; }
    function nextSpread(){ if(isZoomed) return; if(currentSpread<totalSpreads) showSpread(currentSpread+1); }
    function prevSpread(){ if(isZoomed) return; if(currentSpread>1) showSpread(currentSpread-1); }

    // === Inline onclickÊí§ÂªÉ„ÅÆ„Åü„ÇÅ„ÄÅ„Éä„Éì„ÇíJS„Åß‰ªò‰∏é ===
    function bindSpreadNav(){
      document.querySelectorAll('.spread .nav-area.next').forEach(el=>{ el.addEventListener('click', nextSpread); });
      document.querySelectorAll('.spread .nav-area.prev').forEach(el=>{ el.addEventListener('click', prevSpread); });
    }

    // „Ç≠„Éº„Éú„Éº„ÉâÔºè„Çø„ÉÉ„ÉÅ
    document.addEventListener('keydown', e=>{ if(isZoomed){ if(e.key==='Escape') zoomOut(); return; } if(e.key==='ArrowLeft') nextSpread(); else if(e.key==='ArrowRight') prevSpread(); });
    let sx=0, ex=0; document.addEventListener('touchstart',e=>{ sx=e.changedTouches[0].screenX; }); document.addEventListener('touchend',e=>{ ex=e.changedTouches[0].screenX; const d=sx-ex; if(Math.abs(d)>50){ if(d>0) nextSpread(); else prevSpread(); } });

    // ============================
    //  ÁîªÂÉè API
    // ============================
    function setCoverImage(type, path){ const c = type==='front' ? document.getElementById('front-cover') : document.getElementById('back-cover'); if(!c) return; const img=c.querySelector('.cover-image'); if(img){ img.src = path || ''; } }
    function renameCoverAsset(type, newName){ const c = type==='front' ? document.getElementById('front-cover') : document.getElementById('back-cover'); if(!c) return; c.setAttribute('data-asset', newName); const img=c.querySelector('.cover-image'); const badge=c.querySelector('.asset-badge'); if(img){ img.setAttribute('data-name', newName); img.alt = newName; } if(badge){ badge.textContent = newName; } }
    function setKomaImage(pageNumber, komaNumber, imagePath){ const pages=[...document.querySelectorAll('.manga-page')].filter(p=>{ const pn=p.querySelector('.page-number'); return pn && Number(pn.textContent)===Number(pageNumber); }); pages.forEach(p=>{ const img = p.querySelector(`.koma[data-koma="${komaNumber}"] img.koma-img-el`); if(img){ img.src = imagePath || ''; } let old=null; if(komaNumber===1) old=p.querySelector('.koma-1 .koma-content'); if(komaNumber===2) old=p.querySelector('.koma-2 .koma-content'); if(komaNumber===3) old=p.querySelector('.koma-3 .koma-content'); if(old && imagePath){ old.style.backgroundImage=`url('${imagePath}')`; old.style.backgroundSize='cover'; old.style.backgroundPosition='center'; old.textContent=''; } }); }
    function renameKomaAsset(pageNumber, komaNumber, newName){ const pages=[...document.querySelectorAll('.manga-page')].filter(p=>{ const pn=p.querySelector('.page-number'); return pn && Number(pn.textContent)===Number(pageNumber); }); pages.forEach(p=>{ const koma = p.querySelector(`.koma[data-koma="${komaNumber}"]`); if(!koma) return; koma.setAttribute('data-asset', newName); const img = koma.querySelector('img.koma-img-el'); const badge = koma.querySelector('.asset-badge'); if(img){ img.setAttribute('data-name', newName); img.alt = newName; } if(badge){ badge.textContent = newName; } }); }

    // ============================
    //  „Ç∫„Éº„É† ‚Üí AI „Éú„ÉÉ„Éà
    // ============================
    const BOOK = document.getElementById('bookRoot');
    const zoomOverlay   = document.getElementById('zoomOverlay');
    const aiBotWrapper  = document.getElementById('aiBotWrapper');
    const backBtn       = document.getElementById('backBtn');

    function generateImageBackground(){ const container=document.getElementById('imageBackground'); container.innerHTML=''; const cellCount=100; for(let i=0;i<cellCount;i++){ const d=document.createElement('div'); d.className='bg-image-cell'; container.appendChild(d);} }

    function zoomIntoKoma(komaEl){
      if(isZoomed) return;
      const rect=komaEl.getBoundingClientRect();
      const cx=rect.left + rect.width/2; const cy=rect.top + rect.height/2;
      BOOK.style.setProperty('--zoom-origin-x', `${cx}px`);
      BOOK.style.setProperty('--zoom-origin-y', `${cy}px`);
      document.body.style.overflow='hidden';
      BOOK.classList.add('zooming-in');
      zoomOverlay.classList.add('active');
      setTimeout(()=>{
        aiBotWrapper.classList.add('active');
        generateImageBackground();
        // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        const responseArea=document.getElementById('aiResponseArea');
        const responseText=document.getElementById('aiResponseText');
        if(responseArea && responseText){
          responseText.textContent='„ÅäÂæÖ„Åü„ÅõÔºÅ';
          responseArea.classList.add('show');
        }
        const inputEl=document.getElementById('userInput'); if(inputEl) inputEl.focus();
        backBtn.classList.add('visible');
      }, 600);
      isZoomed=true;
    }

    function zoomOut(){
      if(!isZoomed) return;
      aiBotWrapper.classList.remove('active');
      backBtn.classList.remove('visible');
      BOOK.classList.remove('zooming-in');
      BOOK.classList.add('zooming-out');
      zoomOverlay.classList.remove('active');
      setTimeout(()=>{
        BOOK.classList.remove('zooming-out');
        const resArea=document.getElementById('aiResponseArea');
        const resText=document.getElementById('aiResponseText');
        if(resArea) resArea.classList.remove('show');
        if(resText) resText.textContent='';
        const input=document.getElementById('userInput'); if(input) input.value='';
        isZoomed=false;
        document.body.style.overflow='auto';
      }, 720);
    }

    // „ÇØ„É™„ÉÉ„ÇØÁôªÈå≤Ôºà4„Éö„Éº„Ç∏ÁõÆ3„Ç≥„ÉûÁõÆ & „Éä„ÉìÔºâ
    document.addEventListener('DOMContentLoaded', ()=>{
      // „Éä„Éì„Çí„Éê„Ç§„É≥„Éâ
      bindSpreadNav();
      // 4„Éö„Éº„Ç∏ÁõÆ3„Ç≥„ÉûÁõÆ
      const target=document.querySelector('[data-page="4"] .koma[data-koma="3"]');
      if(target){ target.addEventListener('click', ()=>zoomIntoKoma(target)); }

      // ÂÖ•Âá∫ÂäõÁ≥ª
      const submitBtn = document.getElementById('submitBtn'); if(submitBtn){ submitBtn.addEventListener('click', sendMessage); }
      const closeBtn = document.getElementById('backBtn'); if(closeBtn){ closeBtn.addEventListener('click', zoomOut); }
      const input=document.getElementById('userInput'); if(input){ input.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } }); }

      // --- „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÊú¨Êñá„Å´Ë™§Ë≤º‰ªò„Åï„Çå„ÅüJS„ÉÜ„Ç≠„Çπ„Éà„ÇíËá™Âãï„ÇØ„É™„Éº„É≥ ---
      const suspectNodes = [];
      document.body.childNodes.forEach(n=>{ if(n.nodeType===3 && /ANTHROPIC_API_KEY|sendMessage|showSpread\(1\)/.test(n.textContent)){ suspectNodes.push(n); } });
      suspectNodes.forEach(n=> n.parentNode && n.parentNode.removeChild(n));

      // ============================
      // „Çπ„É¢„Éº„ÇØ„ÉÜ„Çπ„ÉàÔºàUIÊúÄÂ∞èÁ¢∫Ë™çÔºâ
      // ============================
      try {
        const activeBefore = document.querySelector('.spread.active');
        const nextBtn = document.querySelector('.spread.active .nav-area.next') || document.querySelector('.nav-area.next');
        if(nextBtn){
          const beforeIdx = activeBefore && activeBefore.getAttribute('data-spread');
          nextBtn.click();
          const afterIdx = document.querySelector('.spread.active')?.getAttribute('data-spread');
          console.assert(beforeIdx !== afterIdx, '[TEST] nextSpread should change active spread');
        }
        console.assert(typeof nextSpread === 'function' && typeof prevSpread === 'function' && typeof showSpread === 'function', '[TEST] navigation functions exist in module scope');
        console.assert(!document.getElementById('welcomeMessage'), '[TEST] welcomeMessage element should not exist');
      } catch (e) { console.warn('[TEST] smoke test warning:', e); }
    });

    // ============================
    //  Claude API Âëº„Å≥Âá∫„ÅóÔºàÈñãÁô∫ËÄÖ„ÅåÈçµ„ÇíË®≠ÂÆöÔºâ
    // ============================
    const ANTHROPIC_API_KEY = window.__ANTHROPIC_API_KEY || 'YOUR_API_KEY_HERE';
    const ANTHROPIC_MODEL   = window.__ANTHROPIC_MODEL   || 'claude-3-opus-20240229';

    async function sendMessage(){
      const input=document.getElementById('userInput');
      const message=(input && input.value || '').trim();
      if(!message) return;
      const submitBtn=document.getElementById('submitBtn');
      const responseArea=document.getElementById('aiResponseArea');
      const responseText=document.getElementById('aiResponseText');

      if(submitBtn){ submitBtn.disabled=true; submitBtn.textContent='Âá¶ÁêÜ‰∏≠'; }
      if(input){ input.disabled=true; }
      if(responseArea){ responseArea.classList.remove('show'); }
      setTimeout(()=>{ if(responseText && responseArea){ responseText.textContent='ËÄÉ„Åà‰∏≠‚Ä¶'; responseArea.classList.add('show'); } }, 80);

      if(!ANTHROPIC_API_KEY){ if(responseText){ responseText.textContent='API„Ç≠„Éº„ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇÈñãÁô∫ËÄÖ„Å´Ë®≠ÂÆö„Çí‰æùÈ†º„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'; } if(submitBtn){ submitBtn.disabled=false; submitBtn.textContent='ÂõûÁ≠î'; } if(input){ input.disabled=false; } return; }

      try{
        console.log('Sending request to Claude API...');
        console.log('Model:', ANTHROPIC_MODEL);
        console.log('Message:', message);
        
        // „É≠„Éº„Ç´„É´„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„ÉºÁµåÁî±„ÅßAPI„ÇíÂëº„Å≥Âá∫„Åô
        // Áõ¥Êé•„Éï„Ç°„Ç§„É´„ÇíÈñã„ÅèÂ†¥Âêà„ÅØCORS„Ç®„É©„Éº„ÅåÁô∫Áîü„Åô„Çã„Åü„ÇÅ„ÄÅ
        // http://localhost:8000 „Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        const apiUrl = window.location.protocol === 'file:' 
          ? 'http://localhost:8000/api/messages'  // „É≠„Éº„Ç´„É´„Çµ„Éº„Éê„Éº‰ΩøÁî®ÊôÇ
          : '/api/messages';  // „Çµ„Éº„Éê„ÉºÁµåÁî±„Åß„Ç¢„ÇØ„Çª„ÇπÊôÇ
        
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'content-type': 'application/json'
          },
          body: JSON.stringify({
            api_key: ANTHROPIC_API_KEY,
            model: ANTHROPIC_MODEL,
            max_tokens: 1000,
            messages: [{ role: 'user', content: message }]
          })
        });
        
        console.log('Response status:', res.status);
        
        if(!res.ok){ 
          const errorData = await res.text();
          console.error('API Error Response:', errorData);
          throw new Error(`Claude API request failed: ${res.status} - ${errorData}`); 
        }
        
        const data = await res.json();
        console.log('API Response:', data);
        
        const aiResponse = (data && data.content && data.content[0] && (data.content[0].text || data.content[0].content)) || 'ÔºàÂøúÁ≠î„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºâ';
        if(responseText){ responseText.textContent = aiResponse; }
      }catch(err){ 
        console.error('Error details:', err); 
        if(responseText){ 
          responseText.textContent='„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message + '\n\nË©≥Á¥∞„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'; 
        } 
      }
      finally{
        if(submitBtn){ submitBtn.disabled=false; submitBtn.textContent='ÂõûÁ≠î'; }
        if(input){ input.disabled=false; input.value=''; input.focus(); }
      }
    }

    // ============================
    //  ÁîªÂÉè„ÅÆË®≠ÂÆö
    // ============================
    function loadAllImages() {
      // Ë°®Á¥ô
      setCoverImage('front', './cover_front.png');
      
      // „Éö„Éº„Ç∏1„ÅÆ„Ç≥„Éû
      setKomaImage(1, 1, './p1_koma1.png');
      setKomaImage(1, 2, './p1_koma2.png');
      setKomaImage(1, 3, './p1_koma3.png');
      
      // „Éö„Éº„Ç∏2„ÅÆ„Ç≥„Éû
      setKomaImage(2, 1, './p2_koma1.png');
      setKomaImage(2, 2, './p2_koma2.png');
      setKomaImage(2, 3, './p2_koma3.png');
      setKomaImage(2, 4, './p2_koma4.png');
      setKomaImage(2, 5, './p2_koma5.png');
      setKomaImage(2, 6, './p2_koma6.png');
      
      // „Éö„Éº„Ç∏3„ÅÆ„Ç≥„Éû
      setKomaImage(3, 1, './p3_koma1.png');
      setKomaImage(3, 2, './p3_koma2.png');
      setKomaImage(3, 3, './p3_koma3.png');
      setKomaImage(3, 4, './p3_koma4.png');
      setKomaImage(3, 5, './p3_koma5.png');
      setKomaImage(3, 6, './p3_koma6.png');
      
      // „Éö„Éº„Ç∏4„ÅÆ„Ç≥„Éû
      setKomaImage(4, 1, './p4_koma1.png');
      setKomaImage(4, 2, './p4_koma2.png');
      setKomaImage(4, 3, './p4_koma3.png');
      
      // Ë£èË°®Á¥ôÔºà„ÇÇ„Åó„ÅÇ„Çå„Å∞Ôºâ
      // setCoverImage('back', './cover_back.png');
    }

    // ÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÄ
    loadAllImages();
    
    // ÂàùÊúüË°®Á§∫ÔºöË°®Á¥ô
    showSpread(1);
  </script>
</body>
</html>
